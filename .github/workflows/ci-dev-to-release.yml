name: CI - Dev to Release

on:
  pull_request:
    branches: [ 'release/**' ]

permissions:
  contents: read
  pull-requests: write

jobs:
  # Job unique: build + lint + audit
  validate:
    name: Build & Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      critical: ${{ steps.vuln-check.outputs.critical }}
      high: ${{ steps.vuln-check.outputs.high }}
      moderate: ${{ steps.vuln-check.outputs.moderate }}
      low: ${{ steps.vuln-check.outputs.low }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Build static site
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Scan for secrets & sensitive files
        run: |
          echo "üîç DevSecOps Security Scan..."
          echo ""

          FOUND=0

          # 1. Fichiers sensibles qui ne devraient JAMAIS √™tre commit√©s
          echo "üìÅ Recherche de fichiers sensibles..."
          SENSITIVE_FILES=$(find . -type f \( \
            -name "*.pem" -o \
            -name "*.key" -o \
            -name "*.p12" -o \
            -name "*.pfx" -o \
            -name "*password*" -o \
            -name "*secret*" -o \
            -name "*credential*" -o \
            -name ".env" -o \
            -name ".env.local" -o \
            -name ".env.production" \
          \) -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/out/*" 2>/dev/null)

          if [ ! -z "$SENSITIVE_FILES" ]; then
            echo "‚ö†Ô∏è Fichiers sensibles d√©tect√©s:"
            echo "$SENSITIVE_FILES"
            FOUND=1
          else
            echo "‚úÖ Pas de fichiers sensibles"
          fi
          echo ""

          # 2. Secrets hardcod√©s dans le code (patterns communs)
          echo "üîê Recherche de secrets hardcod√©s..."

          # API Keys (format typique: 15+ caract√®res alphanum√©riques)
          if grep -r -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][a-zA-Z0-9_-]{15,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ö†Ô∏è API key potentielle d√©tect√©e"
            grep -rn -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][a-zA-Z0-9_-]{15,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Tokens (GitHub, JWT, etc.)
          if grep -r -E "(token|bearer|auth)\s*[=:]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ö†Ô∏è Token potentiel d√©tect√©"
            grep -rn -E "(token|bearer|auth)\s*[=:]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Passwords hardcod√©s
          if grep -r -E "(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{3,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ö†Ô∏è Password hardcod√© d√©tect√©"
            grep -rn -E "(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{3,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Private keys
          if grep -r "BEGIN.*PRIVATE KEY" . \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.txt" --include="*.pem" \
            -not -path "*/node_modules/*" -not -path "*/.git/*" \
            2>/dev/null; then
            echo "‚ö†Ô∏è Private key d√©tect√©e"
            grep -rn "BEGIN.*PRIVATE KEY" . \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.txt" --include="*.pem" \
              -not -path "*/node_modules/*" -not -path "*/.git/*" \
              2>/dev/null
            FOUND=1
          fi

          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ Pas de secrets hardcod√©s d√©tect√©s"
          fi
          echo ""

          # 3. URLs/endpoints sensibles (best practice: utiliser variables d'env)
          echo "üåê V√©rification des URLs hardcod√©es..."
          HARDCODED_URLS=$(grep -r -E "(https?://[a-zA-Z0-9.-]+\.(com|net|org|io))" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null | \
            grep -v "github.com" | \
            grep -v "nextjs.org" | \
            grep -v "vercel.com" | \
            grep -v "localhost" | \
            grep -v "example.com" | \
            wc -l)

          if [ "$HARDCODED_URLS" -gt 0 ]; then
            echo "‚ÑπÔ∏è  $HARDCODED_URLS URL(s) hardcod√©e(s) trouv√©e(s)"
            echo "   Conseil: Utiliser des variables d'environnement pour les URLs d'API"
          else
            echo "‚úÖ Pas d'URLs sensibles hardcod√©es"
          fi
          echo ""

          # R√©sum√© final
          if [ $FOUND -eq 1 ]; then
            echo "‚ö†Ô∏è  SECRETS/FICHIERS SENSIBLES D√âTECT√âS"
            echo "   ‚Üí Non bloquant pour dev, mais √† corriger avant release"
          else
            echo "‚úÖ Scan de s√©curit√© DevSecOps OK"
          fi
        continue-on-error: true

      - name: Check for vulnerabilities (RELEASE GATE)
        id: vuln-check
        run: |
          echo "üîç npm audit - Gate vers Release..."
          echo "üìã Politique: 0 critical, 0 high, <5 moderate, <10 low"
          echo ""
          
          # Capturer la sortie de npm audit
          set +e
          AUDIT_OUTPUT=$(npm audit --json 2>&1)
          AUDIT_EXIT=$?
          set -e
          
          # Parser les r√©sultats JSON
          CRITICAL=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          HIGH=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          MODERATE=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.moderate // 0' 2>/dev/null || echo "0")
          LOW=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.low // 0' 2>/dev/null || echo "0")
          
          echo "üìä R√©sultats du scan:"
          echo "- Critical severity vulnerabilities: $CRITICAL"
          echo "- High severity vulnerabilities: $HIGH"
          echo "- Moderate severity vulnerabilities: $MODERATE"
          echo "- Low severity vulnerabilities: $LOW"
          echo ""
          
          # Export vers output pour le summary
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          
          # V√©rifier les seuils
          FAILED=0
          
          if [ $CRITICAL -gt 0 ]; then
            echo "‚ùå BLOQU√â: $CRITICAL vuln√©rabilit√©(s) CRITICAL (seuil: 0)"
            FAILED=1
          fi
          
          if [ $HIGH -gt 0 ]; then
            echo "‚ùå BLOQU√â: $HIGH vuln√©rabilit√©(s) HIGH (seuil: 0)"
            FAILED=1
          fi
          
          if [ $MODERATE -ge 5 ]; then
            echo "‚ùå BLOQU√â: $MODERATE vuln√©rabilit√©(s) MODERATE (seuil: <5)"
            FAILED=1
          fi
          
          if [ $LOW -ge 10 ]; then
            echo "‚ùå BLOQU√â: $LOW vuln√©rabilit√©(s) LOW (seuil: <10)"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "üîß Actions requises:"
            echo "  1. Ex√©cutez: npm audit fix"
            echo "  2. Si impossible: npm audit fix --force (attention aux breaking changes)"
            echo "  3. Mettez √† jour manuellement les d√©pendances si n√©cessaire"
            echo ""
            npm audit || true
            exit 1
          fi
          
          echo "‚úÖ Seuils de vuln√©rabilit√©s respect√©s - OK pour release"
          
          # Afficher les vuln√©rabilit√©s restantes (warning seulement)
          if [ $MODERATE -gt 0 ] || [ $LOW -gt 0 ]; then
            echo ""
            echo "‚ÑπÔ∏è  Vuln√©rabilit√©s dans les limites acceptables:"
            [ $MODERATE -gt 0 ] && echo "  - $MODERATE moderate (acceptable: <5)"
            [ $LOW -gt 0 ] && echo "  - $LOW low (acceptable: <10)"
            echo ""
            echo "üìã D√©tails des vuln√©rabilit√©s:"
            npm audit || true
          fi

      - name: Generate Summary
        if: always()
        run: |
          echo "# üìä CI - Dev to Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## üìä Vuln√©rabilit√©s npm audit:" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical severity vulnerabilities:** ${{ steps.vuln-check.outputs.critical || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **High severity vulnerabilities:** ${{ steps.vuln-check.outputs.high || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate severity vulnerabilities:** ${{ steps.vuln-check.outputs.moderate || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Low severity vulnerabilities:** ${{ steps.vuln-check.outputs.low || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Seuils pour Release:" >> $GITHUB_STEP_SUMMARY
          echo "- Critical: **0** (actuel: ${{ steps.vuln-check.outputs.critical || 'N/A' }})" >> $GITHUB_STEP_SUMMARY
          echo "- High: **0** (actuel: ${{ steps.vuln-check.outputs.high || 'N/A' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Moderate: **<5** (actuel: ${{ steps.vuln-check.outputs.moderate || 'N/A' }})" >> $GITHUB_STEP_SUMMARY
          echo "- Low: **<10** (actuel: ${{ steps.vuln-check.outputs.low || 'N/A' }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìå **Prochaine √©tape:** release ‚Üí main (0 vuln√©rabilit√© tol√©r√©e)" >> $GITHUB_STEP_SUMMARY

      - name: Check bundle size (info)
        run: |
          echo "üì¶ Build output size:"
          du -sh out/
          ls -lh out/ | head -20

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jobResult = '${{ job.status }}';
            const critical = '${{ steps.vuln-check.outputs.critical }}' || '0';
            const high = '${{ steps.vuln-check.outputs.high }}' || '0';
            const moderate = '${{ steps.vuln-check.outputs.moderate }}' || '0';
            const low = '${{ steps.vuln-check.outputs.low }}' || '0';

            const allPassed = jobResult === 'success';
            const statusEmoji = allPassed ? '‚úÖ' : '‚ùå';
            const statusText = allPassed ? 'Tous les checks sont pass√©s !' : 'Certains checks ont √©chou√©';

            let vulnWarning = '';
            if (critical > 0 || high > 0 || moderate >= 5 || low >= 10) {
              vulnWarning = '\n\n‚ö†Ô∏è **Action requise:** Vuln√©rabilit√©s d√©tect√©es au-dessus des seuils acceptables.';
            } else if (moderate > 0 || low > 0) {
              vulnWarning = '\n\n‚ÑπÔ∏è Vuln√©rabilit√©s dans les limites acceptables (pas de blocage).';
            }

            const comment = `## ${statusEmoji} CI Dev ‚Üí Release - ${statusText}

            ### üìä R√©sultat du build

            | √âtape | Statut |
            |-------|--------|
            | **Build & Security Check** | ${allPassed ? '‚úÖ Succ√®s' : '‚ùå √âchec'} |

            ### üîí Vuln√©rabilit√©s npm audit

            | Criticit√© | Nombre | Seuil |
            |-----------|--------|-------|
            | **Critical** | ${critical} | 0 |
            | **High** | ${high} | 0 |
            | **Moderate** | ${moderate} | < 5 |
            | **Low** | ${low} | < 10 |
            ${vulnWarning}

            ### üìå Prochaine √©tape
            Une fois merg√©e dans \`release/*\`, cette branche devra passer le check **release ‚Üí main** avec **0 vuln√©rabilit√© tol√©r√©e**.

            ---

            <sub>ü§ñ Commentaire automatique g√©n√©r√© par la CI ‚Ä¢ [Voir les d√©tails complets](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            // Trouver un √©ventuel commentaire pr√©c√©dent de la CI
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('CI Dev ‚Üí Release -')
            );

            // Mettre √† jour le commentaire existant ou en cr√©er un nouveau
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
