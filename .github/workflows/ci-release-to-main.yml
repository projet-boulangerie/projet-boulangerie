name: CI - release to Main

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  # Job 0: V√©rifier que la PR vient bien d'une branche release/*
  check-branch:
    name: Check Branch Name
    runs-on: ubuntu-latest

    steps:
      - name: Verify source branch is release/*
        run: |
          echo "üîç V√©rification de la branche source..."
          echo "Branche source: ${{ github.head_ref }}"
          echo "Branche cible: ${{ github.base_ref }}"

          if [[ "${{ github.head_ref }}" == release/* ]]; then
            echo "‚úÖ Branche source valide: ${{ github.head_ref }}"
          else
            echo "‚ùå ERREUR: Seules les branches 'release/*' peuvent cr√©er des PR vers main"
            echo "   Branche actuelle: ${{ github.head_ref }}"
            echo "   Branches accept√©es: release/* (ex: release/v1.0, release/v1.0.1)"
            exit 1
          fi

  # Job 1: Validation production stricte
  validate-production:
    name: Build & Lint (Strict)
    runs-on: ubuntu-latest
    needs: [check-branch]
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      - name: Verify package-lock integrity
        run: |
          echo "üîç V√©rification int√©grit√© package-lock.json..."
          npm install --package-lock-only
          
          # V√©rifier si des changements significatifs (pas juste des flags dev/peer)
          if git diff --exit-code package-lock.json > /dev/null 2>&1; then
            echo "‚úÖ package-lock.json OK"
          else
            echo "‚ö†Ô∏è Diff√©rences d√©tect√©es dans package-lock.json"
            
            # V√©rifier si ce sont juste des changements de flags (dev, peer, optional)
            SIGNIFICANT_CHANGES=$(git diff package-lock.json | grep -E '^\+|^\-' | grep -v '^\+\+\+\|^\-\-\-' | grep -vE '"(dev|peer|optional)": true' | grep -vE '\+.*"dev": true' | grep -vE '\-.*"peer": true' | wc -l)
            
            if [ $SIGNIFICANT_CHANGES -gt 0 ]; then
              echo "‚ùå Changements significatifs d√©tect√©s dans package-lock.json"
              echo "Diff complet:"
              git diff package-lock.json | head -100
              exit 1
            else
              echo "‚úÖ Seulement des changements de flags (dev/peer) - acceptable"
            fi
          fi

      - name: Run ESLint (strict - 0 warnings)
        run: npm run lint -- --max-warnings 0

      - name: Build production
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      - name: Verify build output
        run: |
          if [ ! -d "out" ] || [ ! -f "out/index.html" ]; then
            echo "‚ùå Build failed"
            exit 1
          fi
          echo "‚úÖ Build successful"

      - name: Upload build for next jobs
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: out/
          retention-days: 7

  # Job 2: Security scanning approfondi
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: validate-production
    timeout-minutes: 15
    outputs:
      critical: ${{ steps.npm-audit.outputs.critical }}
      high: ${{ steps.npm-audit.outputs.high }}
      moderate: ${{ steps.npm-audit.outputs.moderate }}
      low: ${{ steps.npm-audit.outputs.low }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      # 1. npm audit STRICT - PRODUCTION (0 vuln√©rabilit√©s tol√©r√©es)
      - name: npm audit (PRODUCTION - ZERO TOLERANCE)
        id: npm-audit
        run: |
          echo "üîç npm audit en mode PRODUCTION (STRICT)..."
          echo "üìã Politique: 0 vuln√©rabilit√© tol√©r√©e (toutes criticit√©s)"
          echo ""

          # Capturer la sortie de npm audit
          set +e
          AUDIT_OUTPUT=$(npm audit --json 2>&1)
          AUDIT_EXIT=$?
          set -e

          # Parser les r√©sultats JSON
          CRITICAL=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          HIGH=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          MODERATE=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.moderate // 0' 2>/dev/null || echo "0")
          LOW=$(echo "$AUDIT_OUTPUT" | jq -r '.metadata.vulnerabilities.low // 0' 2>/dev/null || echo "0")

          echo "üìä R√©sultats du scan:"
          echo "- Critical severity vulnerabilities: $CRITICAL"
          echo "- High severity vulnerabilities: $HIGH"
          echo "- Moderate severity vulnerabilities: $MODERATE"
          echo "- Low severity vulnerabilities: $LOW"
          echo ""

          # Export vers output pour le summary
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "moderate=$MODERATE" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT

          TOTAL=$((CRITICAL + HIGH + MODERATE + LOW))

          if [ $TOTAL -gt 0 ]; then
            echo "‚ùå BLOQU√â: $TOTAL vuln√©rabilit√©(s) d√©tect√©e(s)"
            echo "‚ùå Politique PRODUCTION: ZERO vuln√©rabilit√© tol√©r√©e"
            echo ""
            echo "üîß Actions requises:"
            echo "  1. Ex√©cutez: npm audit fix"
            echo "  2. Si impossible √† corriger automatiquement: npm audit fix --force"
            echo "  3. V√©rifiez les breaking changes apr√®s --force"
            echo "  4. Mettez √† jour manuellement si n√©cessaire"
            echo ""
            npm audit --production || true
            exit 1
          fi

          echo "‚úÖ Aucune vuln√©rabilit√© d√©tect√©e - PRODUCTION OK"

      # 2. Trivy - Scan des d√©pendances (gratuit, rapide)
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # Bloque si critical/high

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      # 3. ESLint security plugin
      - name: Install ESLint Security Plugin
        run: npm install --no-save eslint-plugin-security

      - name: Run ESLint Security checks
        run: |
          cat > eslint.security.config.mjs << 'EOF'
          import security from 'eslint-plugin-security';

          export default [
            {
              ignores: ["node_modules/**", ".next/**", "out/**"]
            },
            {
              files: ["**/*.{js,jsx,ts,tsx}"],
              plugins: {
                security
              },
              rules: {
                'security/detect-object-injection': 'error',
                'security/detect-non-literal-regexp': 'warn',
                'security/detect-unsafe-regex': 'error',
                'security/detect-buffer-noassert': 'error',
                'security/detect-child-process': 'error',
                'security/detect-eval-with-expression': 'error',
                'security/detect-non-literal-fs-filename': 'warn',
                'security/detect-possible-timing-attacks': 'warn',
                'security/detect-pseudoRandomBytes': 'error'
              }
            }
          ];
          EOF

          npx eslint . --config eslint.security.config.mjs --ext .js,.jsx,.ts,.tsx || {
            echo "‚ùå Probl√®mes de s√©curit√© d√©tect√©s"
            exit 1
          }
          echo "‚úÖ ESLint security checks passed"

      # 4. Secrets scanning - DevSecOps am√©lior√© (BLOQUANT pour production)
      - name: Scan for secrets & sensitive files
        run: |
          echo "üîç DevSecOps Security Scan (PRODUCTION - STRICT)..."
          echo ""

          FOUND=0

          # 1. Fichiers sensibles qui ne devraient JAMAIS √™tre commit√©s
          echo "üìÅ Recherche de fichiers sensibles..."
          SENSITIVE_FILES=$(find . -type f \( \
            -name "*.pem" -o \
            -name "*.key" -o \
            -name "*.p12" -o \
            -name "*.pfx" -o \
            -name "*password*" -o \
            -name "*secret*" -o \
            -name "*credential*" -o \
            -name ".env" -o \
            -name ".env.local" -o \
            -name ".env.production" \
          \) -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/out/*" 2>/dev/null)

          if [ ! -z "$SENSITIVE_FILES" ]; then
            echo "‚ùå Fichiers sensibles d√©tect√©s:"
            echo "$SENSITIVE_FILES"
            FOUND=1
          else
            echo "‚úÖ Pas de fichiers sensibles"
          fi
          echo ""

          # 2. Secrets hardcod√©s dans le code (patterns communs)
          echo "üîê Recherche de secrets hardcod√©s..."

          # API Keys (format typique: 15+ caract√®res alphanum√©riques)
          if grep -r -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][a-zA-Z0-9_-]{15,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ùå API key potentielle d√©tect√©e"
            grep -rn -E "(api[_-]?key|apikey)\s*[=:]\s*['\"][a-zA-Z0-9_-]{15,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Tokens (GitHub, JWT, etc.)
          if grep -r -E "(token|bearer|auth)\s*[=:]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ùå Token potentiel d√©tect√©"
            grep -rn -E "(token|bearer|auth)\s*[=:]\s*['\"][a-zA-Z0-9_-]{20,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Passwords hardcod√©s
          if grep -r -E "(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{3,}['\"]" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null; then
            echo "‚ùå Password hardcod√© d√©tect√©"
            grep -rn -E "(password|passwd|pwd)\s*[=:]\s*['\"][^'\"]{3,}['\"]" \
              app/ components/ lib/ \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
              2>/dev/null | head -5
            FOUND=1
          fi

          # Private keys
          if grep -r "BEGIN.*PRIVATE KEY" . \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.txt" --include="*.pem" \
            -not -path "*/node_modules/*" -not -path "*/.git/*" \
            2>/dev/null; then
            echo "‚ùå Private key d√©tect√©e"
            grep -rn "BEGIN.*PRIVATE KEY" . \
              --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.txt" --include="*.pem" \
              -not -path "*/node_modules/*" -not -path "*/.git/*" \
              2>/dev/null
            FOUND=1
          fi

          if [ $FOUND -eq 0 ]; then
            echo "‚úÖ Pas de secrets hardcod√©s d√©tect√©s"
          fi
          echo ""

          # 3. URLs/endpoints sensibles (best practice: utiliser variables d'env)
          echo "üåê V√©rification des URLs hardcod√©es..."
          HARDCODED_URLS=$(grep -r -E "(https?://[a-zA-Z0-9.-]+\.(com|net|org|io))" \
            app/ components/ lib/ \
            --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
            2>/dev/null | \
            grep -v "github.com" | \
            grep -v "nextjs.org" | \
            grep -v "vercel.com" | \
            grep -v "localhost" | \
            grep -v "example.com" | \
            wc -l)

          if [ "$HARDCODED_URLS" -gt 0 ]; then
            echo "‚ÑπÔ∏è  $HARDCODED_URLS URL(s) hardcod√©e(s) trouv√©e(s)"
            echo "   Conseil: Utiliser des variables d'environnement pour les URLs d'API"
          else
            echo "‚úÖ Pas d'URLs sensibles hardcod√©es"
          fi
          echo ""

          # R√©sum√© final - BLOQUANT pour production
          if [ $FOUND -eq 1 ]; then
            echo "‚ùå SECRETS/FICHIERS SENSIBLES D√âTECT√âS"
            echo "   ‚Üí BLOQU√â pour production - Corriger avant de merger vers main"
            exit 1
          else
            echo "‚úÖ Scan de s√©curit√© DevSecOps OK"
          fi

      # 5. V√©rifier fichiers sensibles (ancienne m√©thode - conserv√©e pour compatibilit√©)
      - name: Check for sensitive files (legacy)
        run: |
          echo "üîç V√©rification suppl√©mentaire de fichiers sensibles..."

          SENSITIVE_PATTERNS=(".env" ".env.local" ".env.production" "credentials.json" "*.pem" "*.key" "id_rsa")
          FOUND=0

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            if find . -name "$pattern" -not -path "*/node_modules/*" -not -path "*/.git/*" | grep -q .; then
              echo "‚ùå Fichier sensible trouv√©: $pattern"
              find . -name "$pattern" -not -path "*/node_modules/*" -not -path "*/.git/*"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "‚ùå FICHIERS SENSIBLES - Ne doivent pas √™tre commit√©s"
            exit 1
          fi

          echo "‚úÖ Aucun fichier sensible"

  # Job 3: Code quality & analysis
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: validate-production
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Cache Next.js
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      - name: Install dependencies
        run: npm ci

      # Check console.log en production
      - name: Check for console statements
        run: |
          echo "üîç Recherche de console.log..."

          if grep -r "console\.\(log\|debug\|info\)" app/ components/ lib/ --include="*.tsx" --include="*.ts" 2>/dev/null; then
            echo "‚ö†Ô∏è console.log/debug/info d√©tect√©s en production"
            echo "Consid√©rez les retirer pour la production"
            # Warning seulement, pas bloquant
          else
            echo "‚úÖ Pas de console.log"
          fi

      # Check TODO/FIXME critiques
      - name: Check for critical TODOs
        run: |
          echo "üîç Recherche de TODOs critiques..."

          if grep -r "TODO.*\(SECURITY\|CRITICAL\|URGENT\)" . --include="*.ts" --include="*.tsx" --include="*.js" 2>/dev/null; then
            echo "‚ùå TODOs critiques d√©tect√©s"
            exit 1
          fi

          if grep -r "FIXME.*\(SECURITY\|CRITICAL\)" . --include="*.ts" --include="*.tsx" --include="*.js" 2>/dev/null; then
            echo "‚ùå FIXMEs critiques d√©tect√©s"
            exit 1
          fi

          echo "‚úÖ Pas de TODOs critiques"

      # V√©rifier dangerouslySetInnerHTML
      - name: Check for dangerous React patterns
        run: |
          echo "üîç Recherche de patterns React dangereux..."

          if grep -r "dangerouslySetInnerHTML" app/ components/ --include="*.tsx" 2>/dev/null; then
            echo "‚ö†Ô∏è dangerouslySetInnerHTML d√©tect√© - v√©rifier XSS"
            grep -rn "dangerouslySetInnerHTML" app/ components/ --include="*.tsx"
            # Warning seulement
          fi

          echo "‚úÖ Check React patterns OK"

      # TypeScript strict verification
      - name: Verify TypeScript strict mode
        run: |
          echo "üîç V√©rification TypeScript strict..."

          if ! grep -q '"strict".*true' tsconfig.json; then
            echo "‚ùå TypeScript strict mode non activ√©"
            exit 1
          fi

          echo "‚úÖ TypeScript strict mode activ√©"

  # Job 4: Build analysis & performance
  build-analysis:
    name: Build Analysis
    runs-on: ubuntu-latest
    needs: validate-production
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download production build
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: out/

      # Analyser la taille du build
      - name: Analyze build size
        run: |
          echo "üìä Analyse du build production..."

          TOTAL_SIZE=$(du -sh out/ | cut -f1)
          echo "Taille totale: $TOTAL_SIZE"

          echo "üìÑ Top 10 plus gros fichiers:"
          find out -type f -exec ls -lh {} \; | sort -k5 -hr | head -10

          # Warning si build trop gros (>10MB pour un site statique)
          SIZE_BYTES=$(du -sb out/ | cut -f1)
          if [ $SIZE_BYTES -gt 10485760 ]; then
            echo "‚ö†Ô∏è Build > 10MB - Consid√©rer l'optimisation"
          fi

          echo "‚úÖ Analyse build compl√©t√©e"

      # V√©rifier structure du build
      - name: Verify build structure
        run: |
          echo "üîç V√©rification structure du build..."

          # Fichiers requis
          [ -f "out/index.html" ] || { echo "‚ùå index.html manquant"; exit 1; }
          [ -d "out/_next" ] || { echo "‚ùå Dossier _next manquant"; exit 1; }

          # Compter les assets
          HTML_COUNT=$(find out -name "*.html" | wc -l)
          JS_COUNT=$(find out -name "*.js" | wc -l)

          echo "HTML files: $HTML_COUNT"
          echo "JS files: $JS_COUNT"

          if [ $HTML_COUNT -eq 0 ]; then
            echo "‚ùå Aucun fichier HTML"
            exit 1
          fi

          echo "‚úÖ Structure du build OK"

      # Test basique du HTML g√©n√©r√©
      - name: Basic HTML validation
        run: |
          echo "üîç Validation HTML basique..."

          # V√©rifier que index.html est valide
          if ! grep -q "<!DOCTYPE html>" out/index.html; then
            echo "‚ùå DOCTYPE HTML manquant"
            exit 1
          fi

          if ! grep -q "<html" out/index.html; then
            echo "‚ùå Tag HTML manquant"
            exit 1
          fi

          echo "‚úÖ HTML validation OK"

  # Job 5: Production gate final
  production-gate:
    name: Final Production Gate
    runs-on: ubuntu-latest
    needs: [validate-production, security-scan, code-quality, build-analysis]

    steps:
      - name: Production gate summary
        run: |
          echo "# üîí Production Security Gate - PASSED" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Tous les checks de s√©curit√© sont pass√©s" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### üìä Vuln√©rabilit√©s npm audit:" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical severity vulnerabilities:** ${{ needs.security-scan.outputs.critical || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **High severity vulnerabilities:** ${{ needs.security-scan.outputs.high || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Moderate severity vulnerabilities:** ${{ needs.security-scan.outputs.moderate || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Low severity vulnerabilities:** ${{ needs.security-scan.outputs.low || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéØ **Politique PRODUCTION: 0 vuln√©rabilit√© (toutes criticit√©s)**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Jobs valid√©s:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Build & Lint (Strict)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Security Scanning (npm audit, Trivy, ESLint security)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Code Quality Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Build Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### S√©curit√©:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Aucune vuln√©rabilit√© high/critical" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Aucun secret d√©tect√©" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Aucun fichier sensible" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ ESLint security OK" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ TypeScript strict mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **Ready for production deployment**" >> $GITHUB_STEP_SUMMARY

      - name: Success
        run: |
          echo "‚úÖ =================================================="
          echo "‚úÖ  PRODUCTION GATE PASSED"
          echo "‚úÖ  All security checks successful"
          echo "‚úÖ  Ready to merge to main"
          echo "‚úÖ =================================================="

      - name: Comment PR with results
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request' && always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const validateProd = '${{ needs.validate-production.result }}';
            const securityScan = '${{ needs.security-scan.result }}';
            const codeQuality = '${{ needs.code-quality.result }}';
            const buildAnalysis = '${{ needs.build-analysis.result }}';
            const critical = '${{ needs.security-scan.outputs.critical }}' || '0';
            const high = '${{ needs.security-scan.outputs.high }}' || '0';
            const moderate = '${{ needs.security-scan.outputs.moderate }}' || '0';
            const low = '${{ needs.security-scan.outputs.low }}' || '0';

            const allPassed = validateProd === 'success' && securityScan === 'success' && codeQuality === 'success' && buildAnalysis === 'success';
            const statusEmoji = allPassed ? 'üéâ' : '‚ùå';
            const statusText = allPassed ? 'PRODUCTION GATE PASSED' : 'Production gate failed';

            const totalVuln = parseInt(critical) + parseInt(high) + parseInt(moderate) + parseInt(low);
            let vulnWarning = '';
            if (totalVuln > 0) {
              vulnWarning = '\n\n‚ùå **BLOQU√â:** Politique PRODUCTION - ZERO vuln√©rabilit√© tol√©r√©e';
            } else {
              vulnWarning = '\n\n‚úÖ **Aucune vuln√©rabilit√© d√©tect√©e - Ready for production!**';
            }

            const comment = `## ${statusEmoji} CI Release ‚Üí Main (PRODUCTION) - ${statusText}

            ### üìä R√©sultats des jobs de production

            | Job | Statut |
            |-----|--------|
            | **Build & Lint (Strict)** | ${validateProd === 'success' ? '‚úÖ Succ√®s' : '‚ùå √âchec'} |
            | **Security Scanning** | ${securityScan === 'success' ? '‚úÖ Succ√®s' : '‚ùå √âchec'} |
            | **Code Quality Analysis** | ${codeQuality === 'success' ? '‚úÖ Succ√®s' : '‚ùå √âchec'} |
            | **Build Analysis** | ${buildAnalysis === 'success' ? '‚úÖ Succ√®s' : '‚ùå √âchec'} |

            ### üîí Vuln√©rabilit√©s npm audit (ZERO TOLERANCE)

            | Criticit√© | Nombre | Seuil PRODUCTION |
            |-----------|--------|------------------|
            | **Critical** | ${critical} | **0** |
            | **High** | ${high} | **0** |
            | **Moderate** | ${moderate} | **0** |
            | **Low** | ${low} | **0** |
            ${vulnWarning}

            ### üõ°Ô∏è S√©curit√© Production
            ${allPassed ? `
            - ‚úÖ npm audit: ZERO vuln√©rabilit√©
            - ‚úÖ Trivy scan: Aucune vuln√©rabilit√© critique/haute
            - ‚úÖ Secrets scan: Aucun secret d√©tect√©
            - ‚úÖ ESLint security: Aucun probl√®me
            - ‚úÖ TypeScript strict mode: Activ√©
            ` : `
            - ‚ö†Ô∏è Certains checks de s√©curit√© ont √©chou√©
            - üìã Consultez les logs pour plus de d√©tails
            `}

            ---

            <sub>ü§ñ Commentaire automatique g√©n√©r√© par la CI ‚Ä¢ [Voir les d√©tails complets](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;

            // Trouver un √©ventuel commentaire pr√©c√©dent de la CI
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('CI Release ‚Üí Main')
            );

            // Mettre √† jour le commentaire existant ou en cr√©er un nouveau
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
